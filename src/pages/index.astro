---
/* src/pages/index.astro */
import BaseLayout from "../layouts/BaseLayout.astro";
import PhotoCard from "../components/PhotoCard.astro"; 
import photosData from "../data/photos.json";

// 1. HERO DATA
const allPhotos = photosData.photos || [];

const validHeroPhotos = allPhotos.filter(p => p.full && p.full.length > 0);
const heroCandidates = JSON.stringify(validHeroPhotos.map(p => ({ 
  full: p.full, 
  alt: p.alt || "Featured photography shot", 
  exif: p.exif || "Unknown Camera" 
})));

// 2. SELECTED WORKS
const selectedIds = [
  "Cities__NYC__IMG_7173",
  "Cities__Seattle__IMG_0522",
  "Cities__SF__IMG_4509",
  "Cities__Chicago__20250711_123627_M6_5292",
  "Street__IMG_0463",
  "Portrait__IMG_2914",
  "Street__20250718_084255_M6_5901",
  "Cities__Boston__IMG_7839"
];

// 3. BUILD THE LIST
const mosaicPhotos = [];
for (const id of selectedIds) {
  const match = allPhotos.find(p => p.id === id);
  if (match && match.src) {
    mosaicPhotos.push(match);
  }
}
---

<BaseLayout title="Home" description="The photography portfolio of J.R.H.">
  
  <section class="hero-section">
    <div class="hero-content">
      <div class="text-group">
        <h1 class="hero-title">
          <span class="line-text">HEATSHOCK</span> 
          <span class="line-text text-gold">PHOTOGRAPHY</span>
        </h1>
        <p class="hero-text">
          Pictures from a life spent between cities.
        </p>
      </div>
      
      <div class="cta-wrapper">
        <a href="/gallery" class="btn-primary">View the Gallery</a>
        <a href="/info" class="btn-text">Info & Process &rarr;</a>
      </div>
    </div>

    <div class="hero-visual">
      <div class="polaroid-stack">
        <img 
          id="hero-img"
          src="" 
          alt="Loading..."
          class="hero-img is-loading" 
          width="600"
          height="750"
          loading="eager"
        />
        <div class="meta-tag">
            <span class="meta-label">FEATURED SHOT</span>
            <span id="hero-exif" class="mono">LOADING DATA...</span>
        </div>
      </div>
    </div>
  </section>

  <section class="mosaic-section">
    <div class="grid-header">
      <span class="mono-label">Selected Works // {new Date().getFullYear()}</span>
    </div>

    <div class="photo-grid">
      {mosaicPhotos.map((photo) => (
        /* REMOVED: The extra wrapper and error script */
        /* ADDED: inline-block to prevent column splitting bugs */
        <div class="masonry-item" style="display: inline-block; width: 100%;">
          <PhotoCard photo={photo} sharp={true} /> 
        </div>
      ))}
    </div>
  </section>

</BaseLayout>

<script id="hero-data" type="application/json" set:html={heroCandidates}></script>

<script is:inline>
  function initHero() {
    const dataEl = document.getElementById('hero-data');
    const img = document.getElementById('hero-img');
    const exif = document.getElementById('hero-exif');
    
    if (!dataEl || !img || !exif) return;

    let candidates = [];
    try {
      candidates = JSON.parse(dataEl.textContent);
    } catch (e) {
      console.error("JSON Parse Error", e);
      return;
    }

    if (!candidates || candidates.length === 0) return;

    const last = sessionStorage.getItem("lastHero");
    let pick = candidates[Math.floor(Math.random() * candidates.length)];
    
    for (let i = 0; i < 5 && pick.full === last; i++) {
      pick = candidates[Math.floor(Math.random() * candidates.length)];
    }
    sessionStorage.setItem("lastHero", pick.full);

    img.src = pick.full;
    img.alt = pick.alt;
    exif.textContent = pick.exif;

    if (img.complete) { img.classList.remove('is-loading'); } 
    else { img.onload = () => img.classList.remove('is-loading'); }
  }
  
  initHero();
  document.addEventListener('astro:after-swap', initHero);
</script>

<style>
  /* === HERO STYLES (Unchanged) === */
  .hero-section {
    min-height: 85svh; 
    display: flex; flex-direction: column;
    align-items: center;
    padding: 1rem 1.5rem 3rem 1.5rem; gap: 2rem;
    overflow-x: hidden; width: 100%;
  }
  .hero-content { display: contents; }
  .text-group { order: 1; display: flex; flex-direction: column; align-items: center; text-align: center; gap: 0.75rem; width: 100%; margin-bottom: 0.5rem; }
  .hero-visual { order: 2; width: 100%; display: flex; justify-content: center; position: relative; z-index: 1; margin-bottom: 1rem; }
  .cta-wrapper { order: 3; display: flex; flex-direction: column; gap: 1rem; width: 100%; align-items: center; }

  @media (min-width: 700px) {
    .hero-section { display: grid; grid-template-columns: 1fr 1fr; gap: 4rem; padding: 4rem 5vw; align-items: center; }
    .hero-content { display: flex; flex-direction: column; align-items: flex-start; text-align: left; order: unset; }
    .text-group { order: unset; align-items: flex-start; text-align: left; gap: 1rem; }
    .cta-wrapper { order: unset; flex-direction: row; width: auto; margin-top: 2rem; }
    .hero-visual { order: unset; margin-bottom: 0; }
  }

  .hero-title { 
    font-family: var(--font-sans); font-weight: 900; 
    font-size: clamp(2.5rem, 5vw, 5.5rem); line-height: 0.95; margin: 0;
    display: flex; flex-direction: column; align-items: center;
  }
  @media (min-width: 700px) { .hero-title { align-items: flex-start; } }
  
  .line-text { display: block; color: var(--text-main); letter-spacing: -0.02em; }
  .text-gold { color: var(--brand-secondary); font-weight: 900; }
  .hero-text { font-family: var(--font-sans); font-size: 1.25rem; color: var(--text-muted); }

  .btn-primary { 
    background-color: var(--text-main); color: var(--bg-paper); padding: 16px 36px; 
    border-radius: 50px; text-decoration: none; font-family: var(--font-sans); 
    box-shadow: 0 4px 15px rgba(0,0,0, 0.1); font-size: 1.05rem; 
  }
  .btn-text { color: var(--text-main); text-decoration: none; font-family: var(--font-sans); }

  /* === POLAROID STACK === */
  .polaroid-stack { position: relative; width: 100%; max-width: 550px; }

  .hero-img {
    width: 100%; height: auto; aspect-ratio: 4/5; object-fit: cover;
    border-radius: var(--radius);
    box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
    transform: rotate(2deg); will-change: transform, opacity; backface-visibility: hidden;
    transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.4s ease-in; 
    opacity: 1; max-height: 80vh; margin: 0 auto; display: block;
  }
  .hero-img.is-loading { opacity: 0; }
  .hero-visual:hover .hero-img { transform: rotate(0deg) scale(1.02); }

  .meta-tag { 
    position: absolute; bottom: 25px; right: -15px; 
    background: var(--bg-surface); border: 1px solid var(--border);
    padding: 10px 20px; display: flex; flex-direction: column; gap: 4px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08); border-radius: 2px; z-index: 2;
    transform: rotate(-1.5deg);
  }
  .meta-label { font-family: var(--font-sans); font-size: 0.875rem; color: var(--brand-secondary); text-transform: uppercase; font-weight: 800; letter-spacing: 0.1em; }
  .mono { font-family: var(--font-mono); font-size: 1rem; color: var(--text-main); }

  /* === GRID SECTION === */
  .mosaic-section { 
    padding: 0 2vw 6rem; 
    max-width: 1600px; 
    margin: 0 auto; 
  }
  
  .grid-header { 
    display: flex; align-items: center; 
    margin-bottom: 2rem; opacity: 0.9; 
    border-bottom: 1px solid var(--border); 
    padding-bottom: 1rem; 
  }
  
  .mono-label { 
    font-family: var(--font-mono); font-size: 1rem; 
    color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; 
  }

  /* --- FIX: Override PhotoCard background for Homepage only --- */
  /* This ensures that if an image is missing/loading, you see NOTHING instead of a grey box */
  .photo-grid :global(.photo-card) {
    background: transparent !important;
  }
</style>