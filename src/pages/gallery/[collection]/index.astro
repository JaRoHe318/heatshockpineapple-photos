---
/* src/pages/gallery/[collection]/index.astro */
import BaseLayout from "../../../layouts/BaseLayout.astro";
import PhotoCard from "../../../components/PhotoCard.astro";
import photosData from "../../../data/photos.json";

// 1. Generate Pages for each Collection
export async function getStaticPaths() {
  const allPhotos = photosData.photos || [];
  const uniqueCollections = [...new Set(allPhotos.map(p => p.collection))];
  
  return uniqueCollections.map(col => ({
    params: { collection: col },
    props: { 
      photos: allPhotos.filter(p => p.collection === col)
    }
  }));
}

const { collection } = Astro.params;
const { photos } = Astro.props;

// --- CONFIG: Collection Definitions ---
const collectionInfo = {
  street: {
    title: "Street",
    desc: "The unscripted choreography of the city. Observations from Boston, Chicago, and New York."
  },
  travel: {
    title: "Transit", 
    desc: "Visual notes from the spaces in between. Not about the destination, but the displacement of being somewhere new."
  },
  portrait: {
    title: "Portraits",
    desc: "The variable element. Friends, strangers, and the brief moments of eye contact that break the pattern."
  },
  uncategorized: {
    title: "Archive",
    desc: "Miscellaneous shots from the cutting room floor."
  }
};

const currentInfo = collectionInfo[collection] || { title: collection, desc: "A collection of photos." };
const displayTitle = currentInfo.title.charAt(0).toUpperCase() + currentInfo.title.slice(1);

// 2. SEPARATE CONTENT
const albumPhotos = photos.filter(p => p.album !== null);
const uniqueAlbums = [...new Set(albumPhotos.map(p => p.album))];
const streamPhotos = photos.filter(p => p.album === null);

// 3. PREPARE ALBUM CARDS
const albumCards = uniqueAlbums.map(name => {
  const pics = albumPhotos.filter(p => p.album === name);
  return {
    name: name,
    count: pics.length,
    cover: pics[0]?.src
  };
});
---

<BaseLayout title={displayTitle} description={currentInfo.desc}>
  
  <header class="collection-header">
    <div class="header-content">
      <a href="/gallery" class="back-link">← All Collections</a>
      <h1 class="collection-title">{displayTitle}</h1>
      <div class="line-break"></div>
      <p class="collection-desc">{currentInfo.desc}</p>
      
      <p class="collection-meta">
        {uniqueAlbums.length > 0 ? `${uniqueAlbums.length} Albums · ` : ""}
        {streamPhotos.length} Singles
      </p>
    </div>
  </header>

  {albumCards.length > 0 && (
    <section class="albums-section">
      <div class="grid-header">
        <span class="mono-label">Albums //</span>
        <div class="line"></div>
      </div>
      
      <div class="album-grid">
        {albumCards.map((alb) => (
          <a href={`/gallery/${collection}/${alb.name}`} class="album-card group">
            <div class="album-cover">
              <img src={alb.cover} alt={alb.name} loading="lazy" />
              <div class="album-overlay">
                <span class="arrow">View Album &rarr;</span>
              </div>
            </div>
            <div class="album-meta">
              <h3>{alb.name}</h3>
              <span class="mono">{alb.count} Frames</span>
            </div>
          </a>
        ))}
      </div>
    </section>
  )}

  {streamPhotos.length > 0 && (
    <section class="stream-section">
      {albumCards.length > 0 && (
        <div class="grid-header">
          <span class="mono-label">Stream //</span>
          <div class="line"></div>
        </div>
      )}
      
      <div class="photo-grid sharp-grid">
        {streamPhotos.map((photo) => (
          <div class="masonry-item">
            <PhotoCard photo={photo} />
          </div>
        ))}
      </div>
    </section>
  )}

</BaseLayout>

<style>
  /* --- HEADER --- */
  .collection-header {
    margin: 3rem 0 5rem 0;
    display: flex;
    justify-content: center;
  }

  .header-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 0.75rem;
    max-width: 700px;
    padding: 0 1.5rem;
  }

  .back-link {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 0.5rem;
    text-decoration: none;
    transition: color 0.2s;
  }
  .back-link:hover { color: var(--brand-secondary); }

  .collection-title {
    font-family: var(--font-serif);
    font-size: clamp(3rem, 5vw, 4rem);
    line-height: 1;
    margin: 0;
    color: var(--text-main);
  }

  .line-break {
    width: 40px;
    height: 2px;
    background: var(--brand-secondary);
    margin: 0.5rem 0;
    opacity: 0.6;
  }

  .collection-desc {
    font-family: var(--font-sans);
    font-size: 1.1rem;
    color: var(--text-muted);
    line-height: 1.6;
  }

  .collection-meta {
    font-family: var(--font-mono);
    font-size: 0.8rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    opacity: 0.7;
    margin-top: 1rem;
  }

  /* --- SECTION HEADERS --- */
  .grid-header {
    display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; opacity: 0.8;
    max-width: 1400px; margin-left: auto; margin-right: auto; padding: 0 2vw;
  }
  .mono-label {
    font-family: var(--font-mono); font-size: 0.8rem; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.1em; white-space: nowrap;
  }
  .line { width: 100%; height: 1px; background: var(--border); opacity: 0.5; }

  /* --- ALBUM PILLARS --- */
  .albums-section { margin-bottom: 6rem; }

  .album-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* 2 cols mobile */
    gap: 1.5rem;
    max-width: 1400px; margin: 0 auto; padding: 0 2vw;
  }
  @media (min-width: 900px) {
    .album-grid { grid-template-columns: repeat(3, 1fr); }
  }

  .album-card { text-decoration: none; display: flex; flex-direction: column; gap: 1rem; cursor: pointer; }

  .album-cover {
    aspect-ratio: 2/3; /* PILLAR LOOK */
    width: 100%;
    position: relative;
    background: var(--bg-surface);
    overflow: hidden;
    /* SHARP EDGES */
    border-radius: 0; 
  }

  .album-cover img {
    width: 100%; height: 100%; object-fit: cover;
    transition: transform 0.6s cubic-bezier(0.25, 1, 0.5, 1), filter 0.4s ease;
    filter: grayscale(10%);
    image-rendering: -webkit-optimize-contrast;
  }
  
  .album-card:hover .album-cover img { transform: scale(1.03); filter: grayscale(0%); }

  .album-overlay {
    position: absolute; inset: 0; background: rgba(0,0,0,0.3);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; transition: opacity 0.3s ease;
  }
  .album-card:hover .album-overlay { opacity: 1; }

  .arrow { 
    color: white; font-family: var(--font-mono); font-size: 0.8rem; 
    border: 1px solid white; padding: 8px 16px; border-radius: 0;
    text-transform: uppercase; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
  }

  .album-meta {
    display: flex; flex-direction: column; gap: 0.25rem;
    border-left: 2px solid transparent; padding-left: 0;
    transition: all 0.3s ease;
  }
  .album-card:hover .album-meta {
    border-left-color: var(--brand-secondary); padding-left: 10px;
  }
  
  .album-meta h3 { 
    font-family: var(--font-serif); font-size: 1.5rem; margin: 0; 
    color: var(--text-main); font-weight: 500; text-transform: capitalize; 
  }
  .album-meta .mono { font-family: var(--font-mono); font-size: 0.75rem; color: var(--text-muted); }

  /* --- STREAM MASONRY --- */
  .photo-grid {
    max-width: 1400px; margin: 0 auto; padding: 0 2vw;
    column-count: 3; column-gap: 4px; /* TIGHT GAP */
  }
  .masonry-item { break-inside: avoid; margin-bottom: 4px; }

  @media (max-width: 600px) {
    .photo-grid { column-count: 2; }
  }
</style>

<style is:global>
  .sharp-grid .photo-card, 
  .sharp-grid .photo-card img { border-radius: 0 !important; }
  .sharp-grid .photo-card { margin: 0 !important; width: 100%; display: block; }
</style>