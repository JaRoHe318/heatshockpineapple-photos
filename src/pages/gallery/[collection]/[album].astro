---
/* src/pages/gallery/[collection]/[album].astro */
import BaseLayout from "../../../layouts/BaseLayout.astro";
import PhotoCard from "../../../components/PhotoCard.astro";
import photosData from "../../../data/photos.json";

// Define the shape of a Photo object
interface Photo {
  id: string;
  src: string;
  full: string;
  alt: string;
  collection: string;
  album: string | null;
  exif?: string;
  width: number;
  height: number;
}

export async function getStaticPaths() {
  const allPhotos = (photosData.photos || []) as Photo[];
  const albumPhotos = allPhotos.filter(p => p.album !== null);
  
  // Explicitly type the paths array to satisfy TS
  const paths: { params: { collection: string; album: string }; props: { photos: Photo[] } }[] = [];
  const seen = new Set<string>();
  
  albumPhotos.forEach(p => {
    if (!p.album) return;

    const key = `${p.collection}/${p.album}`;
    if (!seen.has(key)) {
      seen.add(key);
      paths.push({
        params: { collection: p.collection, album: p.album },
        props: { 
          photos: allPhotos.filter(img => img.collection === p.collection && img.album === p.album)
        }
      });
    }
  });

  return paths;
}

const { collection, album } = Astro.params;
const { photos } = Astro.props;

// --- CONFIG: Collection Names ---
const collectionNames: Record<string, string> = {
  street: "Street",
  cities: "Cities",
  portrait: "Portraits",
  uncategorized: "Archive"
};

// --- CONFIG: Album Descriptions ---
// FIX: Added ': Record<string, string>' so TS allows using any string to look up values
const albumDescriptions: Record<string, string> = {
  "boston": "Old brick meeting new glass. Walking the irregular streets where history overlaps with the morning commute.",
  "chicago": "The grid and the river. A study in structure, cold wind, and the way steel frames the sky.",
  "nyc": "Verticality and compression. The light hits differently when it has to travel down forty stories to reach the pavement.",
  "seattle": "Rain shadows and ferries. A city that exists in the gray space between the mountains and the sound.",
  "sf": "Fog lines and steep gradients. A collection of moments from the bay.",
  "vancouver bc": "Glass towers on the edge of the wilderness. Where the Pacific meets the pavement.",
  "los angeles": "Sprawl and golden hour. Finding the moments of stillness in the endless motion of the freeway city.",
  "east lansing": "Quiet spaces and campus lines. Observations from the places where things move a little slower."
};

// Cast collection to string for safety, though TS knows it's a string
const collectionKey = (collection || "").toLowerCase();
const parentTitle = collectionNames[collectionKey] || collection?.charAt(0).toUpperCase() + collection?.slice(1) || "Collection";

// Normalize album to lowercase for lookup
const albumKey = (album || "").toLowerCase();

// Get the title and description safely
const displayTitle = album ? album : 'Album'; 
const displayDesc = albumDescriptions[albumKey] || `Selected frames from ${displayTitle}.`; 

const coverImage = photos.length > 0 ? photos[0].src : undefined;
---

<BaseLayout title={`${displayTitle} - ${parentTitle}`} image={coverImage}>
  
  <header class="collection-header">
    <div class="header-content">
      <a href={`/gallery/${collection}`} class="back-link">‚Üê {parentTitle}</a>
      <h1 class="collection-title">{displayTitle}</h1>
      
      <div class="line-break"></div>
      
      <p class="album-desc">{displayDesc}</p>
      
      <p class="collection-count">{photos.length} Frames</p>
    </div>
  </header>

  <section class="photo-grid">
    {photos.map((photo) => (
      <div class="masonry-item">
        <PhotoCard photo={photo} sharp={true} />
      </div>
    ))}
  </section>
  
  <div class="spacer"></div>

</BaseLayout>

<style>
  /* --- HEADER --- */
  .collection-header {
    margin: 3rem 0 4rem 0;
    display: flex;
    justify-content: flex-start;
    max-width: 1400px;
    margin-left: auto; margin-right: auto;
    padding: 0 2vw;
  }

  .header-content {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    text-align: left;
    gap: 0.75rem;
    max-width: 650px;
  }

  .back-link {
    font-family: var(--font-mono);
    font-size: 0.85rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    text-decoration: none;
    transition: color 0.2s;
  }
  .back-link:hover { color: var(--brand-secondary); }
  
  .collection-title {
    font-family: var(--font-sans);
    font-weight: 900;
    font-size: clamp(3rem, 5vw, 4rem);
    margin: 0;
    line-height: 1;
    color: var(--text-main);
    text-transform: uppercase;
  }

  .line-break {
    width: 40px;
    height: 2px;
    background: var(--brand-secondary);
    margin: 0.5rem 0;
    opacity: 0.6;
    align-self: flex-start;
  }

  .album-desc {
    font-family: var(--font-sans);
    font-size: 1.1rem;
    line-height: 1.6;
    color: var(--text-muted);
    margin: 0.5rem 0 0 0;
  }

  .collection-count {
    font-family: var(--font-mono);
    font-size: 0.9rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-top: 0.5rem;
  }

  /* --- MASONRY GRID --- */
  .photo-grid {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 2vw;
    column-count: 3;
    column-gap: 4px;
  }

  .masonry-item {
    break-inside: avoid;
    margin-bottom: 4px;
    backface-visibility: hidden;
    transform: translateZ(0);
    will-change: transform;
  }

  @media (max-width: 600px) {
    .photo-grid { column-count: 2; }
  }

  .spacer { height: 6rem; }

  .photo-grid img { image-rendering: -webkit-optimize-contrast; }
</style>