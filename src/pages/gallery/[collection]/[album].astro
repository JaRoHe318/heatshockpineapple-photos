---
/* src/pages/gallery/[collection]/[album].astro */
import BaseLayout from "../../../layouts/BaseLayout.astro";
import PhotoCard from "../../../components/PhotoCard.astro";
import photosData from "../../../data/photos.json";

// Define the shape of a Photo object
interface Photo {
  id: string;
  src: string;
  full: string;
  alt: string;
  collection: string;
  album: string | null;
  exif?: string;
  width: number;
  height: number;
}

export async function getStaticPaths() {
  const allPhotos = (photosData.photos || []) as Photo[];
  const albumPhotos = allPhotos.filter(p => p.album !== null);
  
  const paths: { params: { collection: string; album: string }; props: { photos: Photo[] } }[] = [];
  const seen = new Set<string>();
  
  albumPhotos.forEach(p => {
    if (!p.album) return;

    const key = `${p.collection}/${p.album}`;
    if (!seen.has(key)) {
      seen.add(key);
      paths.push({
        params: { collection: p.collection, album: p.album },
        props: { 
          photos: allPhotos.filter(img => img.collection === p.collection && img.album === p.album)
        }
      });
    }
  });

  return paths;
}

const { collection, album } = Astro.params;
const { photos } = Astro.props;

// --- CONFIG: Name Mapping ---
const collectionNames = {
  street: "Street",
  cities: "Cities",
  portrait: "Portraits",
  uncategorized: "Archive"
};

const collectionKey = collection as keyof typeof collectionNames;
const parentTitle = collectionNames[collectionKey] || collection.charAt(0).toUpperCase() + collection.slice(1);

const displayTitle = album ? album.charAt(0).toUpperCase() + album.slice(1) : 'Album';
const coverImage = photos.length > 0 ? photos[0].src : undefined;
---

<BaseLayout title={`${displayTitle} - ${parentTitle}`} image={coverImage}>
  
  <header class="collection-header">
    <div class="header-content">
      <a href={`/gallery/${collection}`} class="back-link">‚Üê {parentTitle}</a>
      <h1 class="collection-title">{displayTitle}</h1>
      <div class="line-break"></div>
      <p class="collection-count">{photos.length} Frames</p>
    </div>
  </header>

  <section class="photo-grid">
    {photos.map((photo) => (
      <div class="masonry-item">
        <PhotoCard photo={photo} sharp={true} />
      </div>
    ))}
  </section>
  
  <div class="spacer"></div>

</BaseLayout>

<style>
  /* --- HEADER --- */
  .collection-header {
    margin: 3rem 0 4rem 0;
    display: flex;
    /* LEFT ALIGN UPDATE */
    justify-content: flex-start;
    max-width: 1400px;
    margin-left: auto; margin-right: auto;
    padding: 0 2vw;
  }

  .header-content {
    display: flex;
    flex-direction: column;
    /* LEFT ALIGN UPDATE */
    align-items: flex-start;
    text-align: left;
    gap: 0.5rem;
  }

  .back-link {
    font-family: var(--font-mono);
    font-size: 0.85rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    text-decoration: none;
    transition: color 0.2s;
  }
  .back-link:hover { color: var(--brand-secondary); }
  
  .collection-title {
    font-family: var(--font-sans);
    font-weight: 900;
    font-size: clamp(3rem, 5vw, 4rem);
    margin: 0;
    line-height: 1;
    color: var(--text-main);
    text-transform: uppercase;
  }

  .line-break {
    width: 40px;
    height: 2px;
    background: var(--brand-secondary);
    margin: 0.5rem 0;
    opacity: 0.6;
    /* LEFT ALIGN UPDATE */
    align-self: flex-start;
  }

  .collection-count {
    font-family: var(--font-mono);
    font-size: 0.9rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  /* --- MASONRY GRID --- */
  .photo-grid {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 2vw;
    column-count: 3;
    column-gap: 4px;
  }

  .masonry-item {
    break-inside: avoid;
    margin-bottom: 4px;
    
    /* --- FIX: GHOST BOX GLITCH --- */
    /* Forces hardware acceleration to prevent painting errors */
    backface-visibility: hidden;
    transform: translateZ(0);
    will-change: transform;
  }

  @media (max-width: 600px) {
    .photo-grid { column-count: 2; }
  }

  .spacer { height: 6rem; }

  .photo-grid img { image-rendering: -webkit-optimize-contrast; }
</style>