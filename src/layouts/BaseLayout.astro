---

import { ClientRouter } from 'astro:transitions'; 
import "../styles/global.css";
import 'photoswipe/style.css';

import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";


interface Props {
  title: string;
  description?: string;
  image?: string;
  canonicalURL?: string;
  type?: string;
}

const {
  title,
  description = "Photography by J. R. Hernandez",
  image = "/social-preview.png",
  canonicalURL = new URL(Astro.url.pathname, Astro.site).href,
  type = "website"
} = Astro.props;

const siteName = "Heat Shock Pineapple · Photos";
const fullTitle = title.includes(siteName) ? title : `${title} · ${siteName}`;
const socialImageURL = new URL(image, Astro.site).href;
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <ClientRouter />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{fullTitle}</title>
    <meta name="title" content={fullTitle} />
    <meta name="description" content={description} />
    <meta name="author" content="Jason Hernandez" />
    <link rel="canonical" href={canonicalURL} />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta property="og:type" content={type} />
    <meta property="og:image" content={socialImageURL} />

    <script is:inline>
        const setTheme = () => {
          const stored = localStorage.getItem("theme");
          const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
          const theme = stored || (prefersDark ? "dark" : "light");
          document.documentElement.setAttribute("data-theme", theme);
        };
        setTheme();
        document.addEventListener("astro:after-swap", setTheme);
    </script>
  </head>
  <body>
    <a href="#main-gallery" class="skip-link">Skip to content</a>


    <Header />
      
    <main id="main-gallery" class="global-wrapper pswp-gallery">
      <slot />
    </main>
      
    <Footer />

    <script>
      import PhotoSwipeLightbox from 'photoswipe/lightbox';
      import PhotoSwipe from 'photoswipe';

      let lightbox;

      function initLightbox() {
        lightbox = new PhotoSwipeLightbox({
          gallery: '#main-gallery', 
          children: 'a.pswp-link',
          pswpModule: PhotoSwipe,
          
          /* 1. OPACITY SETTINGS */
          /* We set this to 1.0 (or nearly 1) so the colors defined in CSS are solid */
          bgOpacity: 0.95, 
          showHideOpacity: true,
          
          /* 2. BEHAVIOR */
          wheelToZoom: true,
          preload: [1, 3],

          paddingFn: (viewportSize) => {
            return { top: 0, bottom: 0, left: 0, right: 0 }
          }
        });

        /* 3. CAPTION LOGIC (The Scraper) */
        lightbox.on('uiRegister', function() {
          lightbox.pswp.ui.registerElement({
            name: 'custom-caption',
            order: 9,
            isButton: false,
            appendTo: 'root',
            html: '',
            onInit: (el, pswp) => {
              lightbox.pswp.on('change', () => {
                const currSlide = lightbox.pswp.currSlide;
                if (currSlide && currSlide.data.element) {
                  const hiddenCaption = currSlide.data.element.parentNode.querySelector('.hidden-caption');
                  if (hiddenCaption) {
                    el.innerHTML = hiddenCaption.innerHTML;
                  } else {
                    el.innerHTML = '';
                  }
                }
              });
            }
          });
        });
        lightbox.init();
      }

      document.addEventListener('astro:page-load', () => {
        if (lightbox) {
          lightbox.destroy();
          lightbox = null;
        }
        initLightbox();
      });
    </script>
  </body>
</html>

<style>
  .global-wrapper {
    width: 100%;
    /* We keep the width/centering logic here */
    max-width: 1600px; 
    margin: 0 auto;
    
    position: relative;
    z-index: 2; 
  }

  /* @media (min-width: 768px) { .global-wrapper { padding: 0 40px; } } */

  /* ================================================== */
  /* PRO STANDARD LIGHTBOX (ALWAYS DARK)              */
  /* ================================================== */
  
  :global(.pswp__bg) {
    /* Deep Charcoal - Best for color perception & contrast */
    background-color: #0e0e0e !important; 
    opacity: 0.98 !important; /* Almost opaque to block out the UI */
    transition: opacity 0.3s ease;
  }

  /* ================================================== */
  /* CAPTION STYLES                                   */
  /* ================================================== */
  :global(.pswp__custom-caption) {
    position: absolute;
    bottom: 0; left: 0; width: 100%;
    /* Subtle gradient to make white text readable on any photo */
    background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
    padding: 4rem 1.5rem 2rem 1.5rem;
    text-align: center;
    color: rgba(255, 255, 255, 0.95); /* Bright white text */
    pointer-events: none;
    z-index: 2000;
  }
  
  :global(.pswp__custom-caption small) {
    font-family: var(--font-mono);
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.85); /* Slightly muted EXIF data */
    display: block;
    letter-spacing: 0.05em;
    text-shadow: 0 1px 3px rgba(0,0,0,0.9);
  }
</style>