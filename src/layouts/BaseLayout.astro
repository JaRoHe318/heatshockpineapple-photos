---
import { ClientRouter } from 'astro:transitions'; 
import "../styles/global.css";
import 'photoswipe/style.css';

import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import MicroscopeBackground from "../components/MicroscopeBackground.astro";

interface Props {
  title: string;
  description?: string;
  image?: string;
  canonicalURL?: string;
  type?: string;
}

const {
  title,
  description = "Photography by J. R. Hernandez",
  image = "/social-preview.png",
  canonicalURL = new URL(Astro.url.pathname, Astro.site).href,
  type = "website"
} = Astro.props;

const siteName = "Heat Shock Pineapple · Photos";
const fullTitle = title.includes(siteName) ? title : `${title} · ${siteName}`;
const socialImageURL = new URL(image, Astro.site).href;
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <ClientRouter />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{fullTitle}</title>
    <meta name="title" content={fullTitle} />
    <meta name="description" content={description} />
    <meta name="author" content="Jason Hernandez" />
    <link rel="canonical" href={canonicalURL} />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta property="og:type" content={type} />
    <meta property="og:image" content={socialImageURL} />

    <script is:inline>
        const setTheme = () => {
          const stored = localStorage.getItem("theme");
          const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
          const theme = stored || (prefersDark ? "dark" : "light");
          document.documentElement.setAttribute("data-theme", theme);
        };
        setTheme();
        document.addEventListener("astro:after-swap", setTheme);
    </script>
  </head>
  <body>
    <MicroscopeBackground />

    <Header />
      
    <main id="main-gallery" class="global-wrapper pswp-gallery">
      <slot />
    </main>
      
    <Footer />

    <script>
      import PhotoSwipeLightbox from 'photoswipe/lightbox';
      import PhotoSwipe from 'photoswipe';

      let lightbox;

      function initLightbox() {
        lightbox = new PhotoSwipeLightbox({
          gallery: '#main-gallery', 
          children: 'a.pswp-link',
          pswpModule: PhotoSwipe,
          // We keep opacity high so the theme color is rich/visible
          bgOpacity: 0.95, 
          showHideOpacity: true,
          wheelToZoom: true,
          paddingFn: (viewportSize) => {
            return { top: 0, bottom: 0, left: 0, right: 0 }
          }
        });

        lightbox.on('uiRegister', function() {
          lightbox.pswp.ui.registerElement({
            name: 'custom-caption',
            order: 9,
            isButton: false,
            appendTo: 'root',
            html: '',
            onInit: (el, pswp) => {
              lightbox.pswp.on('change', () => {
                const currSlide = lightbox.pswp.currSlide;
                if (currSlide && currSlide.data.element) {
                  const hiddenCaption = currSlide.data.element.parentNode.querySelector('.hidden-caption');
                  if (hiddenCaption) {
                    el.innerHTML = hiddenCaption.innerHTML;
                  } else {
                    el.innerHTML = '';
                  }
                }
              });
            }
          });
        });
        lightbox.init();
      }

      document.addEventListener('astro:page-load', () => {
        if (lightbox) {
          lightbox.destroy();
          lightbox = null;
        }
        initLightbox();
      });
    </script>
  </body>
</html>

<style>
  .global-wrapper {
    width: 100%;
    max-width: 1400px; 
    margin: 0 auto;
    padding: 0 24px;
    min-height: 80vh; 
    position: relative;
    z-index: 2; 
  }

  @media (min-width: 768px) { 
    .global-wrapper { 
      padding: 0 40px; 
    } 
  }

  /* --- THEME-AWARE LIGHTBOX BACKGROUND --- */
  /* This forces the lightbox to match your Day (Cream) or Night (Dark) theme */
  :global(.pswp__bg) {
    background: var(--bg-body) !important;
    transition: background-color 0.3s ease; /* Smooth transition if user toggles theme while open */
  }

  /* --- LIGHTBOX CAPTION STYLES --- */
  :global(.pswp__custom-caption) {
    position: absolute;
    bottom: 0; 
    left: 0;
    width: 100%;
    /* Dark gradient ensures white text is readable even on Cream background */
    background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
    padding: 4rem 1.5rem 2rem 1.5rem;
    text-align: center;
    color: rgba(255, 255, 255, 0.9);
    pointer-events: none;
    z-index: 2000;
  }
  
  :global(.pswp__custom-caption small) {
    font-family: var(--font-mono);
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.85);
    display: block;
    letter-spacing: 0.05em;
    text-shadow: 0 1px 3px rgba(0,0,0,0.8);
  }
</style>