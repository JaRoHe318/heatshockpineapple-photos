---
import Search from "./Search.astro";

// NAVIGATION CONFIG
const BRAND_LINK = "https://heatshockpineapple.com"; 
const HOME_LINK = "/"; 

const pathname = new URL(Astro.request.url).pathname;
const currentPath = pathname.slice(1);
---

<header class="site-header">
  <div class="header-inner">
    
    <a href={BRAND_LINK} class="site-title">
      <img src="/images/ui/logo.png" alt="Heat Shock Pineapple" class="header-logo" />
      <span class="brand-text">
        <span class="brand-main">Heat Shock</span><span class="gold"> Pineapple</span>
      </span>
    </a>

    <div class="header-controls">
      <nav id="site-nav" class="site-nav">
        <a href={HOME_LINK} class={currentPath === "" ? "active" : ""}>Home</a>
        <a href="/gallery" class={currentPath.startsWith("gallery") ? "active" : ""}>Gallery</a>
        <a href="/resources" class={currentPath.startsWith("resources") ? "active" : ""}>Resources</a>

        <div class="mobile-icons">
          <button class="icon-btn search-trigger" aria-label="Open Search" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <span>Search</span>
          </button>
          
          <button class="icon-btn theme-trigger" aria-label="Toggle Dark Mode" type="button">
            <span class="theme-text">Theme</span>
            <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
          </button>
        </div>
      </nav>

      <div class="control-separator desktop-only"></div>

      <button class="icon-btn search-trigger desktop-only" aria-label="Open Search" type="button">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      </button>

      <button class="icon-btn theme-trigger desktop-only" aria-label="Toggle Dark Mode" type="button">
        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
        <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
      </button>

      <button id="menu-toggle" class="menu-toggle" aria-label="Toggle Menu" type="button">
        <span class="bar"></span><span class="bar"></span><span class="bar"></span>
      </button>
      
    </div>
  </div>
</header>

<div id="search-modal" class="search-modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-bg" id="modal-bg" aria-hidden="true"></div>
  <div class="modal-content" role="document">
    <Search />
  </div>
</div>

<script type="module">
  function setupHeader() {
    let menuToggle = document.getElementById('menu-toggle');
    const nav = document.getElementById('site-nav');

    const searchBtns = document.querySelectorAll('.search-trigger');
    const searchModal = document.getElementById('search-modal');
    const modalBg = document.getElementById('modal-bg');

    // Replace node helper
    const replaceWithClone = (el) => {
      if (!el?.parentNode) return el;
      const clone = el.cloneNode(true);
      el.parentNode.replaceChild(clone, el);
      return clone;
    };

    // 1. MOBILE MENU
    if (menuToggle && nav) {
      const newToggle = replaceWithClone(menuToggle);
      menuToggle = newToggle;

      menuToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        menuToggle.classList.toggle('open');
        nav.classList.toggle('open');
      });

      nav.querySelectorAll('a').forEach((link) => {
        link.addEventListener('click', () => {
          menuToggle.classList.remove('open');
          nav.classList.remove('open');
        });
      });
    }

    // 2. MODAL LOGIC & BRIDGE
    let lastFocusedElement;

    function openModal() {
      const currentModal = document.getElementById('search-modal');
      if (!currentModal) return;
      
      lastFocusedElement = document.activeElement;

      if (nav) nav.classList.remove('open');
      if (menuToggle) menuToggle.classList.remove('open');

      currentModal.classList.add('open');
      currentModal.setAttribute('aria-hidden', 'false');
      document.body.classList.add('modal-open');

      setTimeout(() => { 
        const input = currentModal.querySelector('input'); 
        if (input) input.focus(); 
      }, 50);
    }

    function closeModal() {
      const currentModal = document.getElementById('search-modal');
      if (!currentModal) return;
      
      currentModal.classList.remove('open');
      currentModal.setAttribute('aria-hidden', 'true');
      document.body.classList.remove('modal-open');
      
      if (lastFocusedElement?.focus) lastFocusedElement.focus();
    }

    // EXPOSE BRIDGE
    window.__hspSearch = window.__hspSearch || {};
    window.__hspSearch.open = openModal;
    window.__hspSearch.close = closeModal;

    // 3. WIRE TRIGGERS
    searchBtns.forEach((btn) => {
      const newBtn = replaceWithClone(btn);
      newBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        openModal();
      });
    });

    const newBg = replaceWithClone(modalBg);
    newBg?.addEventListener('click', closeModal);

    // 4. GLOBAL KEYDOWN GUARD
    if (!window.__hspHeaderKeydownBound) {
      window.__hspHeaderKeydownBound = true;

      document.addEventListener('keydown', (e) => {
        const activeModal = document.getElementById('search-modal');
        const isOpen = activeModal?.classList.contains('open');

        // ESCAPE
        if (e.key === 'Escape' && isOpen) {
          window.__hspSearch?.close?.();
          return;
        }

        // CMD+K
        const tag = document.activeElement?.tagName?.toLowerCase();
        const isTyping = tag === 'input' || tag === 'textarea' || document.activeElement?.isContentEditable;
        
        if (!isTyping && (e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'k') {
          e.preventDefault();
          window.__hspSearch?.open?.();
          return;
        }

        // FOCUS TRAP
        if (isOpen && e.key === 'Tab') {
          const focusables = activeModal.querySelectorAll(
            'a[href], button:not([disabled]), input, textarea, select, [tabindex]:not([tabindex="-1"])'
          );
          if (focusables.length) {
            const first = focusables[0];
            const last = focusables[focusables.length - 1];
            if (e.shiftKey && document.activeElement === first) {
              e.preventDefault(); last.focus();
            } else if (!e.shiftKey && document.activeElement === last) {
              e.preventDefault(); first.focus();
            }
          }
        }
      });
    }

    // 5. GLOBAL RESULT CLICK GUARD
    if (!window.__hspSearchResultClickBound) {
      window.__hspSearchResultClickBound = true;
      document.addEventListener('click', (e) => {
        const modal = document.getElementById('search-modal');
        if (!modal?.classList.contains('open')) return;
        const a = e.target?.closest?.('#search-modal a');
        if (a) window.__hspSearch?.close?.();
      });
    }

    // 6. THEME TOGGLE
    document.querySelectorAll('.theme-trigger').forEach((btn) => {
      const newBtn = replaceWithClone(btn);
      newBtn.addEventListener('click', () => {
        const element = document.documentElement;
        const current = element.getAttribute("data-theme");
        const next = current === "dark" ? "light" : "dark";
        element.setAttribute("data-theme", next);
        localStorage.setItem("theme", next);
      });
    });
  }

  setupHeader();
  document.addEventListener('astro:page-load', setupHeader);
  document.addEventListener('astro:after-swap', setupHeader);
</script>

<style>
  /* === THE GREEN HEADER === */
  .site-header { 
    position: sticky; top: 0; z-index: 1000; padding: 1.2rem 0;
  }
  .site-header::before {
    content: ""; position: absolute; inset: 0; z-index: -1;
    background: #243b30; 
    opacity: 0.95;
    backdrop-filter: blur(12px);
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }

  .header-inner { 
    width: 100%; max-width: 1600px; margin: 0 auto; 
    padding: 0 2rem; 
    display: flex; justify-content: space-between; align-items: center; 
  }
  
  /* BRAND */
  .site-title { display: flex; align-items: center; gap: 0.75rem; text-decoration: none; z-index: 1002; }
  
  .brand-text { 
    font-family: var(--font-serif); 
    font-weight: 600; 
    font-size: 1.3rem; 
    color: #ffffff;
    word-spacing: -0.15em;
    letter-spacing: 0.01em; 
  }
  
  .gold { 
    color: var(--accent-secondary); 
    font-style: normal;
    font-size: 1.02em; 
  }

  .header-logo { height: 32px; width: auto; border-radius: 4px; }

  /* CONTROLS */
  .header-controls { display: flex; align-items: center; gap: 1rem; }
  .control-separator { width: 1px; height: 24px; background: rgba(255,255,255,0.2); margin: 0 0.5rem; }

  /* ICONS */
  .icon-btn { 
    background: none; border: none; cursor: pointer; padding: 5px; display: flex; align-items: center; transition: color 0.2s;
    color: rgba(255,255,255,0.7);
  }
  .icon-btn:hover { color: #ffffff; }

  /* NAV LINKS */
  .site-nav { display: flex; gap: 1.5rem; }
  .site-nav a { 
    font-size: 1.05rem; font-weight: 500; text-decoration: none; font-family: var(--font-sans); 
    color: rgba(255,255,255,0.7);
  }
  .site-nav a:hover, .site-nav a.active { color: #ffffff; }
  
  /* THEME ICONS */
  .moon-icon { display: none; }
  .sun-icon { display: block; }
  :global([data-theme="dark"]) .sun-icon { display: none; }
  :global([data-theme="dark"]) .moon-icon { display: block; }

  /* RESPONSIVE */
  .menu-toggle { display: none; }
  .mobile-icons { display: none; }

  @media (max-width: 768px) {
    .desktop-only { display: none !important; }
    .menu-toggle { display: flex; flex-direction: column; justify-content: space-between; width: 30px; height: 21px; background: transparent; border: none; cursor: pointer; z-index: 1002; padding: 0; }
    .bar { width: 100%; height: 3px; background-color: #ffffff; border-radius: 3px; transition: all 0.3s ease; }
    
    .menu-toggle.open .bar:nth-child(1) { transform: translateY(9px) rotate(45deg); }
    .menu-toggle.open .bar:nth-child(2) { opacity: 0; }
    .menu-toggle.open .bar:nth-child(3) { transform: translateY(-9px) rotate(-45deg); }

    .site-nav { display: none; }
    .site-nav.open {
      display: flex; position: fixed; inset: 0; 
      background-color: #243b30;
      flex-direction: column; justify-content: center; align-items: center; gap: 2rem; z-index: 1001;
    }
    .site-nav.open a { font-size: 1.5rem; font-weight: 600; color: #fff; }
    .mobile-icons { display: flex; gap: 2rem; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(255,255,255,0.2); }
    .mobile-icons .icon-btn { flex-direction: column; gap: 8px; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; color: #fff; }
  }

  /* SEARCH MODAL */
  .search-modal { position: fixed; inset: 0; z-index: 2000; display: flex; justify-content: center; align-items: flex-start; padding-top: 15vh; opacity: 0; pointer-events: none; transition: opacity 0.2s ease; }
  .search-modal.open { opacity: 1; pointer-events: auto; }
  
  .modal-bg { 
    position: absolute; 
    inset: 0; 
    background: var(--overlay-bg); /* NEEDS GLOBAL VAR */
    backdrop-filter: blur(8px); 
  }
  
  .modal-content { position: relative; width: 100%; max-width: 700px; z-index: 2001; animation: slideDown 0.3s ease-out; }
  @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

  :global(body.modal-open) { overflow: hidden; }
</style>